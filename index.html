<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f0f2f5; color: #333; padding: 15px; line-height: 1.5; }
        .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 500px; margin: auto; margin-bottom: 20px; }
        .badge { background: #0088cc; color: white; padding: 5px 10px; border-radius: 5px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .price { color: #2ecc71; font-size: 22px; font-weight: bold; margin: 15px 0; }
        
        /* AI Bo'limlari stili */
        .ai-section { background: #eef9ff; border-left: 4px solid #0088cc; padding: 15px; margin-top: 15px; border-radius: 0 10px 10px 0; }
        .konspekt-section { background: #fff4e6; border-left: 4px solid #ff922b; padding: 15px; margin-top: 15px; border-radius: 0 10px 10px 0; }
        .taklif-section { margin-top: 15px; }
        
        .taklif-tag { display: inline-block; background: #e9ecef; color: #495057; padding: 6px 12px; border-radius: 20px; font-size: 13px; margin: 4px; border: 1px solid #dee2e6; }
        
        #ai-text, #ai-konspekt { font-size: 14px; color: #2c3e50; margin-top: 8px; white-space: pre-wrap; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        tr { border-bottom: 1px solid #eee; }
        td { padding: 12px 0; }
        .label { color: #666; font-weight: 500; }
        .value { text-align: right; font-weight: bold; color: #333; }
        
        button { width: 100%; padding: 14px; background: #0088cc; color: white; border: none; border-radius: 12px; margin-top: 25px; font-size: 16px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div class="card">
        <span class="badge">PRO REJIM | AI TAHLIL</span>
        <h2 id="dori-nomi" style="margin: 10px 0 5px 0;">Yuklanmoqda...</h2>
        <p id="mnn" style="color: #666; font-size: 13px; margin: 0;"></p>
        
        <div class="price" id="narx"></div>
        
        <table>
            <tr>
                <td class="label">‚öñÔ∏è Doza/Shakl:</td>
                <td id="doza" class="value"></td>
            </tr>
            <tr>
                <td class="label">üè¢ Ishlab chiqaruvchi:</td>
                <td id="zavod" class="value"></td>
            </tr>
        </table>

        <div class="ai-section">
            <strong style="color: #0088cc; display: flex; align-items: center; gap: 5px;">
                <span>ü§ñ</span> AI Tibbiy Tahlili:
            </strong>
            <div id="ai-text">Ma'lumotlar tahlil qilinmoqda...</div>
        </div>

        <div class="konspekt-section" id="section-konspekt" style="display:none;">
            <strong style="color: #e67e22; display: flex; align-items: center; gap: 5px;">
                <span>üìö</span> Guruh haqida konspekt:
            </strong>
            <div id="ai-konspekt"></div>
        </div>

        <div class="taklif-section" id="section-takliflar" style="display:none;">
            <strong style="color: #333; font-size: 14px; margin-left: 5px;">üíä O'xshash dori vositalari:</strong>
            <div id="ai-takliflar" style="margin-top: 10px;"></div>
        </div>

        <button onclick="Telegram.WebApp.close()">Sahifani yopish</button>
    </div>

    <script>
    const tg = window.Telegram.WebApp;
    tg.expand(); 
    tg.ready();

    const params = new URLSearchParams(window.location.search);

    // 1. Asosiy ma'lumotlarni o'rnatish
    document.getElementById('dori-nomi').innerText = params.get('name') || 'Noma ºlum dori';
    document.getElementById('mnn').innerText = params.get('mnn') || 'Tarkib ma ºlumoti yo ªq';
    document.getElementById('doza').innerText = params.get('doza') || '-';
    document.getElementById('zavod').innerText = params.get('zavod') || 'Noma ºlum zavod';
    document.getElementById('narx').innerText = (params.get('price') || '0') + " so'm";
    
    // 2. AI ma'lumotlarini qabul qilish va bo'lish
    const rawAiData = params.get('ai_data');
    if (rawAiData) {
        const fullText = decodeURIComponent(rawAiData);
        
        // Regex orqali qismlarga ajratish
        const infoPart = fullText.match(/INFO:([\s\S]*?)(?=GURUHI:|$)/i)?.[1] || fullText;
        const konspektPart = fullText.match(/KONSPEKT:([\s\S]*?)(?=TAKLIFLAR:|$)/i)?.[1] || "";
        const takliflarPart = fullText.match(/TAKLIFLAR:([\s\S]*)/i)?.[1] || "";

        // Ma'lumotlarni sahifaga chiqarish
        document.getElementById('ai-text').innerText = infoPart.trim();

        if (konspektPart.trim()) {
            document.getElementById('section-konspekt').style.display = 'block';
            document.getElementById('ai-konspekt').innerText = konspektPart.trim();
        }

        // 3. TAKLIFLARNI TUGMA SIFATIDA YARATISH (YANGI QISM)
        if (takliflarPart.trim()) {
            document.getElementById('section-takliflar').style.display = 'block';
            const takliflarDiv = document.getElementById('ai-takliflar');
            takliflarDiv.innerHTML = ''; // Tozalash

            const dorilar = takliflarPart.split(',');
            
            dorilar.forEach(dori => {
                const doriNomi = dori.trim();
                if (doriNomi) {
                    const btn = document.createElement('button');
                    btn.className = 'taklif-tag'; // CSS'dagi stil
                    btn.style.width = 'auto'; // Default 100% ni bekor qilish
                    btn.style.margin = '5px';
                    btn.style.cursor = 'pointer';
                    btn.innerText = doriNomi;
                    
                    btn.onclick = async () => {
                        // 1. WebApp-ni yopmasdan, sarlavhani o'zgartiramiz
                        document.getElementById('dori-nomi').innerText = "AI tahlil qilmoqda: " + doriNomi;
                        document.getElementById('ai-text').innerText = "Kuting, AI ushbu analog dori haqida ma'lumot tayyorlayapti...";

                        // 2. Bot orqali yangi ma'lumot so'rash (Xabar yuborish)
                        // Inline WebApp-larda biz ma'lumotni tg.sendData emas, query orqali boshqarishimiz osonroq
                        tg.sendData(doriNomi); 
                        // Agar bot terminalda handle_webapp_data bo'lsa, u yangi ma'lumotni chiqaradi
                    };
                    takliflarDiv.appendChild(btn);
                }
            });
        }
    } else {
        document.getElementById('ai-text').innerText = "AI tahlili yuklanmadi.";
    }
</script>
</body>
</html>