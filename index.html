<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Sizning mavjud stillaringiz */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f0f2f5; color: #333; padding: 15px; line-height: 1.5; }
        .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 500px; margin: auto; margin-bottom: 20px; }
        .badge { background: #0088cc; color: white; padding: 5px 10px; border-radius: 5px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .price { color: #2ecc71; font-size: 22px; font-weight: bold; margin: 15px 0; }
        .ai-section { background: #eef9ff; border-left: 4px solid #0088cc; padding: 15px; margin-top: 15px; border-radius: 0 10px 10px 0; transition: all 0.3s; }
        .konspekt-section { background: #fff4e6; border-left: 4px solid #ff922b; padding: 15px; margin-top: 15px; border-radius: 0 10px 10px 0; }
        .taklif-section { margin-top: 15px; }
        .taklif-tag { display: inline-block; background: #e9ecef; color: #495057; padding: 8px 14px; border-radius: 20px; font-size: 13px; margin: 4px; border: 1px solid #dee2e6; cursor: pointer; transition: 0.2s; }
        .taklif-tag:hover { background: #0088cc; color: white; border-color: #0088cc; }
        #ai-text, #ai-konspekt { font-size: 14px; color: #2c3e50; margin-top: 8px; white-space: pre-wrap; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        tr { border-bottom: 1px solid #eee; }
        td { padding: 12px 0; }
        .label { color: #666; font-weight: 500; }
        .value { text-align: right; font-weight: bold; color: #333; }
        .loading-dots:after { content: ' .'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); } 40% { color: #0088cc; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); } 60% { text-shadow: .25em 0 0 #0088cc, .5em 0 0 rgba(0,0,0,0); } 80%, 100% { text-shadow: .25em 0 0 #0088cc, .5em 0 0 #0088cc; } }
    </style>
</head>
<body>
    <div class="card">
        <span class="badge" id="status-badge">PRO REJIM | AI TAHLIL</span>
        <h2 id="dori-nomi" style="margin: 10px 0 5px 0;">Yuklanmoqda...</h2>
        <p id="mnn" style="color: #666; font-size: 13px; margin: 0;"></p>
        
        <div class="price" id="narx"></div>
        
        <table id="main-table">
            <tr><td class="label">‚öñÔ∏è Doza/Shakl:</td><td id="doza" class="value"></td></tr>
            <tr><td class="label">üè¢ Ishlab chiqaruvchi:</td><td id="zavod" class="value"></td></tr>
        </table>

        <div class="ai-section">
            <strong style="color: #0088cc; display: flex; align-items: center; gap: 5px;">
                <span>ü§ñ</span> AI Tibbiy Tahlili:
            </strong>
            <div id="ai-text">Ma'lumotlar tahlil qilinmoqda...</div>
        </div>

        <div class="konspekt-section" id="section-konspekt" style="display:none;">
            <strong style="color: #e67e22; display: flex; align-items: center; gap: 5px;">
                <span>üìö</span> Guruh haqida konspekt:
            </strong>
            <div id="ai-konspekt"></div>
        </div>

        <div class="taklif-section" id="section-takliflar" style="display:none;">
            <strong style="color: #333; font-size: 14px; margin-left: 5px;">üíä O'xshash dori vositalari:</strong>
            <div id="ai-takliflar" style="margin-top: 10px;"></div>
        </div>

        <button onclick="Telegram.WebApp.close()" style="width: 100%; padding: 14px; background: #0088cc; color: white; border: none; border-radius: 12px; margin-top: 25px; font-size: 16px; font-weight: bold; cursor: pointer;">Sahifani yopish</button>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    // URL-dan parametrlarni o'qish uchun URLSearchParams e'lon qilamiz
    const params = new URLSearchParams(window.location.search);
    
    // AI API Key-ni bot yuborgan URL-dan yoki qattiq koddan olamiz
    const OPENAI_API_KEY = params.get('ai_key') || "Sizning_OpenAI_Keyingiz"; 
    
    tg.expand();
    tg.ready();

    // 1. UI-ni yangilash funksiyasi
    function updateUI(data) {
        // Asosiy ma'lumotlar
        document.getElementById('dori-nomi').innerText = data.name || "Noma'lum";
        document.getElementById('mnn').innerText = data.mnn || 'Tarkib ma ºlumoti yo ªq';
        document.getElementById('doza').innerText = data.doza || '-';
        document.getElementById('zavod').innerText = data.zavod || 'Noma ºlum zavod';
        document.getElementById('narx').innerText = (data.price && data.price !== "0") ? data.price + " so'm" : "Narx noma'lum";

        if (data.ai_data) {
            const fullText = decodeURIComponent(data.ai_data);
            
            // Bot yuborgan formatga qarab matnni qismlarga bo'lamiz
            // Agar matnda maxsus teglar bo'lmasa, hammasini INFO qismiga chiqaramiz
            const infoPart = fullText.match(/üíäGuruhi:([\s\S]*?)(?=üß™Mexanizmi:|$)/i)?.[1] || fullText;
            const konspektPart = fullText.match(/KONSPEKT:([\s\S]*?)(?=TAKLIFLAR:|$)/i)?.[1] || "";
            const takliflarPart = fullText.match(/TAKLIFLAR:([\s\S]*)/i)?.[1] || "";

            // AI matnini chiqarish
            const aiTextField = document.getElementById('ai-text');
            if (aiTextField) aiTextField.innerText = infoPart.trim();

            // Konspekt bo'limi
            const kSection = document.getElementById('section-konspekt');
            const kText = document.getElementById('ai-konspekt');
            if (kSection && kText) {
                if (konspektPart.trim()) {
                    kSection.style.display = 'block';
                    kText.innerText = konspektPart.trim();
                } else {
                    kSection.style.display = 'none';
                }
            }

            // Takliflar (Analoglar) bo'limi
            const tSection = document.getElementById('section-takliflar');
            const div = document.getElementById('ai-takliflar');
            if (tSection && div) {
                if (takliflarPart.trim()) {
                    tSection.style.display = 'block';
                    div.innerHTML = '';
                    takliflarPart.split(',').forEach(dori => {
                        const name = dori.trim();
                        if (name) {
                            const span = document.createElement('span');
                            span.className = 'taklif-tag';
                            span.innerText = name;
                            span.style.cursor = 'pointer';
                            span.onclick = () => fetchNewAIData(name);
                            div.appendChild(span);
                        }
                    });
                } else {
                    tSection.style.display = 'none';
                }
            }
        }
    }

    // 2. Analog dori ustiga bosilganda WebApp ichida yangi AI tahlili
    async function fetchNewAIData(doriName) {
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        const nameHeader = document.getElementById('dori-nomi');
        const aiField = document.getElementById('ai-text');
        
        if (nameHeader) nameHeader.innerHTML = `<span class="loading">Qidirilmoqda: ${doriName}...</span>`;
        if (aiField) aiField.innerText = "Kuting, AI yangi dori ma'lumotlarini tahlil qilmoqda...";

        const prompt = `${doriName} dori vositasi haqida o'zbek tilida professional farmatsevtik ma'lumot ber. 
        Format: INFO: (umumiy tahlil), KONSPEKT: (batafsil mexanizmi), TAKLIFLAR: (3 ta o'xshash dori nomi vergul bilan)`;

        try {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${OPENAI_API_KEY}`
                },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: [{ role: "user", content: prompt }]
                })
            });

            const result = await response.json();
            const aiText = result.choices[0].message.content;

            updateUI({
                name: doriName,
                mnn: "Tahlil qilinmoqda",
                doza: "-",
                zavod: "Aniqlanmoqda",
                price: "Noma'lum",
                ai_data: encodeURIComponent(aiText)
            });
        } catch (error) {
            if (aiField) aiField.innerText = "Xatolik: AI bilan ulanish imkonsiz.";
            console.error("Fetch Error:", error);
        }
    }

    // 3. Birinchi marta ochilganda botdan kelgan ma'lumotlarni yuklash
    try {
        const initialData = {
            name: params.get('name'),
            mnn: params.get('mnn'),
            doza: params.get('doza'),
            zavod: params.get('zavod'),
            price: params.get('price'),
            ai_data: params.get('ai_data')
        };
        updateUI(initialData);
    } catch (e) {
        console.error("Initial Load Error:", e);
    }
</script>
</body>
</html>